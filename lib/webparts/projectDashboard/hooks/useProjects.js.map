{"version":3,"file":"useProjects.js","sourceRoot":"","sources":["../../../../src/webparts/projectDashboard/hooks/useProjects.ts"],"names":[],"mappings":"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","sourcesContent":["// hooks/useProjects.ts\r\nimport { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport { getSP } from '../services/pnp';\r\nimport { IProject, ITask, IUser, ProjectStatus, Priority } from '../models/types';\r\n\r\nexport interface UseProjectsOptions {\r\n  projectsListTitle: string;\r\n  tasksListTitle: string;\r\n}\r\n\r\nexport interface UseProjectsState {\r\n  projects: IProject[];\r\n  loading: boolean;\r\n  error?: string;\r\n}\r\n\r\nexport const useProjects = (opts: UseProjectsOptions) => {\r\n  const [state, setState] = useState<UseProjectsState>({ projects: [], loading: true });\r\n\r\n  const load = useCallback(async () => {\r\n    setState(s => ({ ...s, loading: true, error: undefined }));\r\n    try {\r\n      const sp = getSP();\r\n\r\n      // Proyectos: ajusta nombres internos segÃºn tus listas\r\n      const projectItems = await sp.web.lists\r\n        .getByTitle(opts.projectsListTitle)\r\n        .items.select(\r\n          'Id',\r\n          'Title',                // Codigo del proyecto\r\n          'NombreProyecto',       \r\n          'PresupuestoTotal',     \r\n          'FechaInicio',          \r\n          'FechaFin',            \r\n          'Estado',               \r\n          'Prioridad',            \r\n          'GerenteProyecto/Id',\r\n          'GerenteProyecto/Title',\r\n          'GerenteProyecto/EMail'\r\n        )\r\n        .expand('GerenteProyecto')\r\n        .top(5000)();\r\n\r\n      const baseProjects: IProject[] = projectItems.map((it: any) => ({\r\n        id: it.Id,\r\n        name: it.NombreProyecto,\r\n        code: it.Title ?? `PROJ-${it.Id}`,\r\n        budget: it.PresupuestoTotal ?? undefined,\r\n        startDate: it.FechaInicio ?? undefined,\r\n        endDate: it.FechaFin ?? undefined,\r\n        status: (it.Estado as ProjectStatus) ?? 'Planning',\r\n        priority: it.Prioridad as Priority,\r\n        manager: it.GerenteDelProyecto\r\n          ? {\r\n              id: it.GerenteDelProyecto.Id,\r\n              displayName: it.GerenteDelProyecto.Title,\r\n              email: it.GerenteDelProyecto.EMail,\r\n            }\r\n          : undefined,\r\n        totalTasks: 0,\r\n        completedTasks: 0,\r\n        blockedTasks: 0,\r\n        progressPct: 0,\r\n      }));\r\n\r\n      if (baseProjects.length === 0) {\r\n        setState({ projects: [], loading: false, error: undefined });\r\n        return;\r\n      }\r\n\r\n      const projectIds = new Set(baseProjects.map(p => p.id));\r\n\r\n      // Tareas\r\n      const taskItems = await sp.web.lists\r\n        .getByTitle(opts.tasksListTitle)\r\n        .items.select(\r\n          'Id',\r\n          'Title',\r\n          'ProyectoRelacionadoId',\r\n          'AsignadoA/Id',\r\n          'AsignadoA/Title',\r\n          'AsignadoA/EMail',\r\n          'HorasEstimadas',\r\n          'PorcentajeCompletado',\r\n          'Estado'\r\n        )\r\n        .expand('AsignadoA')\r\n        .filter(`ProyectoRelacionadoId ne null`)\r\n        .top(5000)();\r\n\r\n      const tasks: ITask[] = taskItems\r\n        .map((t: any) => ({\r\n          id: t.Id,\r\n          title: t.Title,\r\n          relatedProjectId: t.ProyectoRelacionadoId,\r\n          assignedTo: t.AsignadoA\r\n            ? {\r\n                id: t.AsignadoA.Id,\r\n                displayName: t.AsignadoA.Title,\r\n                email: t.AsignadoA.EMail,\r\n              }\r\n            : undefined,\r\n          estimatedHours: t.HorasEstimadas ?? undefined,\r\n          percentComplete:\r\n            typeof t.PorcentajeCompletado === 'number'\r\n              ? Math.min(100, Math.max(0, t.PorcentajeCompletado))\r\n              : 0,\r\n          status: (t.Estado as any) ?? 'Not Started',\r\n        }))\r\n        .filter(t => projectIds.has(t.relatedProjectId));\r\n\r\n      // Agregaciones\r\n      const tasksByProject = new Map<number, ITask[]>();\r\n      tasks.forEach(t => {\r\n        const arr = tasksByProject.get(t.relatedProjectId) ?? [];\r\n        arr.push(t);\r\n        tasksByProject.set(t.relatedProjectId, arr);\r\n      });\r\n\r\n      const projectsWithAgg = baseProjects.map(p => {\r\n        const pTasks = tasksByProject.get(p.id) ?? [];\r\n        const totalTasks = pTasks.length;\r\n        const completedTasks = pTasks.filter(t => t.status === 'Completed').length;\r\n        const blockedTasks = pTasks.filter(t => t.status === 'Blocked').length;\r\n        const avgPct =\r\n          totalTasks > 0\r\n            ? Math.round(pTasks.reduce((sum, t) => sum + (t.percentComplete || 0), 0) / totalTasks)\r\n            : 0;\r\n\r\n        return { ...p, totalTasks, completedTasks, blockedTasks, progressPct: avgPct };\r\n      });\r\n\r\n      setState({ projects: projectsWithAgg, loading: false, error: undefined });\r\n    } catch (err: any) {\r\n      setState({ projects: [], loading: false, error: err?.message ?? 'Error cargando datos' });\r\n    }\r\n  }, [opts.projectsListTitle, opts.tasksListTitle]);\r\n\r\n  useEffect(() => { load(); }, [load]);\r\n\r\n  const managers = useMemo(() => {\r\n    const uniq = new Map<number, IUser>();\r\n    state.projects.forEach(p => { if (p.manager) uniq.set(p.manager.id, p.manager); });\r\n    return Array.from(uniq.values());\r\n  }, [state.projects]);\r\n\r\n  const statuses: ProjectStatus[] = useMemo(\r\n    () => ['Planning', 'Active', 'Completed', 'Cancelled'],\r\n    []\r\n  );\r\n\r\n  return { ...state, reload: load, managers, statuses };\r\n};"]}